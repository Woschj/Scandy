{% extends "base.html" %}

{% block title %}Manuelle Ausleihe{% endblock %}

{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Linke Spalte: Item-Auswahl -->
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
            <div class="flex gap-4">
                <!-- Icon-Buttons statt Tabs -->
                <div class="flex flex-col gap-2">
                    <button class="btn btn-square btn-active" 
                            data-tab="tools" 
                            onclick="switchType('tools')">
                        <i class="fas fa-tools"></i>
                    </button>
                    <button class="btn btn-square" 
                            data-tab="consumables" 
                            onclick="switchType('consumables')">
                        <i class="fas fa-box-open"></i>
                    </button>
                </div>

                <div class="flex-1">
                    <h2 class="card-title mb-4">Artikel auswählen</h2>

                    <!-- Item Details -->
                    <div id="itemDetails" class="mb-4 p-4 bg-base-200 rounded-lg hidden">
                        <h3 class="font-bold mb-2" id="itemDetailName"></h3>
                        <div class="text-sm space-y-1">
                            <p>Barcode: <span id="itemDetailBarcode"></span></p>
                            <p id="itemDetailQuantity" class="hidden">Bestand: <span></span></p>
                            <p id="itemDetailStatus" class="hidden">Status: <span></span></p>
                        </div>
                    </div>

                    <!-- Suchfeld -->
                    <div class="form-control mb-4">
                        <input type="text" 
                               id="itemSearch" 
                               placeholder="Suchen..." 
                               class="input input-bordered">
                    </div>

                    <!-- Item Liste -->
                    <div class="form-control">
                        <select id="itemSelect" size="10" class="select select-bordered w-full h-[400px] overflow-y-auto">
                            <optgroup label="Werkzeuge" id="toolsGroup">
                                {% for tool in tools %}
                                <option value="tool:{{ tool.id }}:{{ tool.barcode }}:{{ tool.name }}"
                                        class="p-2 hover:bg-base-200">
                                    {{ tool.name }} ({{ tool.barcode }})
                                </option>
                                {% endfor %}
                            </optgroup>
                            <optgroup label="Verbrauchsmaterial" id="consumablesGroup" style="display:none;">
                                {% for consumable in consumables %}
                                <option value="consumable:{{ consumable.id }}:{{ consumable.barcode }}:{{ consumable.name }}"
                                        class="p-2 hover:bg-base-200">
                                    {{ consumable.name }} (Bestand: {{ consumable.quantity }})
                                </option>
                                {% endfor %}
                            </optgroup>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mittlere Spalte: Mitarbeiter-Auswahl -->
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
            <div class="flex gap-4">
                <!-- Platzhalter für Symmetrie -->
                <div class="w-[52px]"></div>

                <div class="flex-1">
                    <h2 class="card-title mb-4">Mitarbeiter auswählen</h2>

                    <!-- Mitarbeiter Details -->
                    <div id="workerDetails" class="mb-4 p-4 bg-base-200 rounded-lg hidden">
                        <h3 class="font-bold mb-2" id="workerDetailName"></h3>
                        <div class="text-sm space-y-1">
                            <p>Abteilung: <span id="workerDetailDepartment"></span></p>
                            <p>Barcode: <span id="workerDetailBarcode"></span></p>
                        </div>
                    </div>

                    <!-- Mitarbeiter-Suche -->
                    <div class="form-control mb-4">
                        <input type="text" 
                               id="workerSearch" 
                               placeholder="Mitarbeiter suchen..." 
                               class="input input-bordered">
                    </div>

                    <!-- Mitarbeiter Liste -->
                    <div class="form-control">
                        <select id="workerSelect" size="10" class="select select-bordered w-full h-[400px] overflow-y-auto">
                            {% for worker in workers %}
                            <option value="{{ worker.barcode }}"
                                    class="p-2 hover:bg-base-200">
                                {{ worker.firstname }} {{ worker.lastname }} ({{ worker.department }})
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Rechte Spalte: Vorschau und Bestätigung -->
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
            <div class="flex gap-4">
                <!-- Platzhalter für Symmetrie -->
                <div class="w-[52px]"></div>

                <div class="flex-1">
                    <h2 class="card-title mb-4">Ausleihe bestätigen</h2>

                    <!-- Vorschau -->
                    <div class="bg-base-200 p-4 rounded-lg mb-6">
                        <h3 class="font-bold mb-4">Zusammenfassung</h3>
                        
                        <!-- Item Vorschau -->
                        <div class="mb-4">
                            <p class="text-sm font-medium text-gray-500">Artikel</p>
                            <p id="previewItem" class="font-medium">-</p>
                        </div>

                        <!-- Mitarbeiter Vorschau -->
                        <div class="mb-4">
                            <p class="text-sm font-medium text-gray-500">Mitarbeiter</p>
                            <p id="previewWorker" class="font-medium">-</p>
                        </div>

                        <!-- Menge (nur für Verbrauchsmaterial) -->
                        <div id="amountContainer" class="mb-4 hidden">
                            <p class="text-sm font-medium text-gray-500">Menge</p>
                            <input type="number" 
                                   id="amountInput" 
                                   class="input input-bordered w-full" 
                                   value="1" 
                                   min="1">
                        </div>
                    </div>

                    <!-- Bestätigungs-Button -->
                    <button id="confirmButton" 
                            class="btn btn-primary w-full" 
                            disabled>
                        Ausleihe bestätigen
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Aktuelle Ausleihen -->
<div class="card bg-base-100 shadow-xl mt-6">
    <div class="card-body">
        <div class="flex gap-4">
            <div class="w-[52px]"></div>
            <div class="flex-1">
                <h2 class="card-title mb-4">Aktuelle Ausleihen</h2>
                <div class="overflow-x-auto">
                    <table class="table w-full">
                        <thead>
                            <tr>
                                <th>Artikel</th>
                                <th>Mitarbeiter</th>
                                <th>Ausgeliehen am</th>
                                <th>Aktion</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for lending in tool_lendings %}
                            <tr>
                                <td>{{ lending.tool_name }}</td>
                                <td>{{ lending.worker_name }}</td>
                                <td>{{ lending.lent_at }}</td>
                                <td>
                                    <button class="btn btn-sm btn-warning"
                                            onclick="returnTool('{{ lending.tool_barcode }}')">
                                        <i class="fas fa-undo mr-2"></i>
                                        Rückgabe
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let selectedItem = null;
let selectedWorker = null;

function switchType(type) {
    // Button-Aktivierung
    document.querySelectorAll('[data-tab]').forEach(btn => {
        if (btn.dataset.tab === type) {
            btn.classList.add('btn-active');
        } else {
            btn.classList.remove('btn-active');
        }
    });
    
    const toolsGroup = document.getElementById('toolsGroup');
    const consumablesGroup = document.getElementById('consumablesGroup');
    const amountContainer = document.getElementById('amountContainer');
    
    if (type === 'tools') {
        toolsGroup.style.display = '';
        consumablesGroup.style.display = 'none';
        amountContainer.classList.add('hidden');
    } else {
        toolsGroup.style.display = 'none';
        consumablesGroup.style.display = '';
        amountContainer.classList.remove('hidden');
    }
    
    // Reset selection
    document.getElementById('itemSelect').value = '';
    document.getElementById('itemDetails').classList.add('hidden');
    updatePreview();
}

function updateItemDetails(itemValue) {
    const itemDetails = document.getElementById('itemDetails');
    if (!itemValue) {
        itemDetails.classList.add('hidden');
        return;
    }

    const [type, id, barcode, name] = itemValue.split(':');
    selectedItem = { type, id, barcode, name };

    document.getElementById('itemDetailName').textContent = name;
    document.getElementById('itemDetailBarcode').textContent = barcode;
    
    const quantityElement = document.getElementById('itemDetailQuantity');
    const statusElement = document.getElementById('itemDetailStatus');
    
    if (type === 'consumable') {
        quantityElement.classList.remove('hidden');
        statusElement.classList.add('hidden');
    } else {
        quantityElement.classList.add('hidden');
        statusElement.classList.remove('hidden');
    }
    
    itemDetails.classList.remove('hidden');
    updatePreview();
}

function updateWorkerDetails(workerValue) {
    const workerDetails = document.getElementById('workerDetails');
    if (!workerValue) {
        workerDetails.classList.add('hidden');
        return;
    }

    selectedWorker = {
        barcode: workerValue,
        name: workerSelect.options[workerSelect.selectedIndex].text
    };

    document.getElementById('workerDetailName').textContent = selectedWorker.name;
    document.getElementById('workerDetailBarcode').textContent = selectedWorker.barcode;
    document.getElementById('workerDetailDepartment').textContent = 
        selectedWorker.name.split('(')[1].replace(')', '');
    
    workerDetails.classList.remove('hidden');
    updatePreview();
}

function updatePreview() {
    const previewItem = document.getElementById('previewItem');
    const previewWorker = document.getElementById('previewWorker');
    const confirmButton = document.getElementById('confirmButton');
    
    previewItem.textContent = selectedItem ? selectedItem.name : '-';
    previewWorker.textContent = selectedWorker ? selectedWorker.name : '-';
    
    confirmButton.disabled = !(selectedItem && selectedWorker);
}

function processLending() {
    if (!selectedItem || !selectedWorker) return;
    
    const amount = selectedItem.type === 'consumable' 
        ? parseInt(document.getElementById('amountInput').value) 
        : 1;
    
    fetch('/api/lending/process', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            item_type: selectedItem.type,
            item_barcode: selectedItem.barcode,
            worker_barcode: selectedWorker.barcode,
            amount: amount
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert(data.message || 'Fehler bei der Ausleihe');
        }
    })
    .catch(error => {
        console.error('Fehler:', error);
        alert('Fehler bei der Ausleihe');
    });
}

function returnTool(toolBarcode) {
    if (!confirm('Möchten Sie die Rückgabe wirklich durchführen?')) return;
    
    fetch('/api/lending/return', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            tool_barcode: toolBarcode
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert(data.message || 'Fehler bei der Rückgabe');
        }
    })
    .catch(error => {
        console.error('Fehler:', error);
        alert('Fehler bei der Rückgabe');
    });
}

// Event Listener
document.addEventListener('DOMContentLoaded', function() {
    const itemSelect = document.getElementById('itemSelect');
    const workerSelect = document.getElementById('workerSelect');
    const itemSearch = document.getElementById('itemSearch');
    const workerSearch = document.getElementById('workerSearch');
    
    itemSelect.addEventListener('change', () => updateItemDetails(itemSelect.value));
    workerSelect.addEventListener('change', () => updateWorkerDetails(workerSelect.value));
    
    itemSearch.addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase();
        Array.from(itemSelect.options).forEach(option => {
            const text = option.text.toLowerCase();
            option.style.display = text.includes(searchTerm) ? '' : 'none';
        });
    });
    
    workerSearch.addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase();
        Array.from(workerSelect.options).forEach(option => {
            const text = option.text.toLowerCase();
            option.style.display = text.includes(searchTerm) ? '' : 'none';
        });
    });
});
</script>

<style>
/* Aktiver Button-Zustand */
.btn-active {
    @apply bg-primary text-primary-content;
}

/* Hover-Effekt für inaktive Buttons */
.btn-square:not(.btn-active):hover {
    @apply bg-base-200;
}
</style>
{% endblock %}

{% block scripts %}
<!-- Spezifische Scripts für diese Seite -->
<script src="{{ url_for('static', filename='js/manual_lending.js') }}"></script>
{% endblock %}