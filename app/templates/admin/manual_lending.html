{% extends "base.html" %}

{% block title %}Manuelle Ausleihe{% endblock %}

{% block head %}
<!-- Table Functions Script -->
<script src="{{ url_for('static', filename='js/table-functions.js') }}" defer></script>
{% endblock %}

{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Linke Spalte: Item-Auswahl -->
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
            <div class="flex gap-4">
                <!-- Icon-Buttons statt Tabs -->
                <div class="flex flex-col gap-2">
                    <button class="btn btn-square btn-active" 
                            data-tab="tools" 
                            onclick="ManualLending.switchType('tools')">
                        <i class="fas fa-tools"></i>
                    </button>
                    <button class="btn btn-square" 
                            data-tab="consumables" 
                            onclick="ManualLending.switchType('consumables')">
                        <i class="fas fa-box-open"></i>
                    </button>
                </div>

                <div class="flex-1">
                    <h2 class="card-title mb-4">Artikel auswählen</h2>

                    <!-- Item Details -->
                    <div id="itemDetails" class="mb-4 p-4 bg-base-200 rounded-lg hidden">
                        <h3 class="font-bold mb-2" id="itemDetailName"></h3>
                        <div class="text-sm space-y-1">
                            <p>Barcode: <span id="itemDetailBarcode"></span></p>
                            <p id="itemDetailQuantity" class="hidden">Bestand: <span></span></p>
                            <p id="itemDetailStatus" class="hidden">Status: <span></span></p>
                        </div>
                    </div>

                    <!-- Suchfeld und Listen-Container -->
                    <div class="form-control">
                        <!-- Suchfeld -->
                        <input type="text" 
                               id="itemSearch" 
                               placeholder="Suchen..." 
                               class="input input-bordered mb-4">

                        <!-- Werkzeug-Liste -->
                        <div id="toolsList" class="h-96 overflow-hidden bg-white rounded-lg shadow">
                            <div class="p-4 border-b">
                                <h3 class="font-semibold">Werkzeuge</h3>
                            </div>
                            <select size="10" 
                                    id="toolSelect"
                                    onchange="ManualLending.selectItem(this.value)"
                                    class="w-full h-[calc(100%-4rem)] overflow-y-auto p-2">
                                {% for tool in tools %}
                                    <option value="tool:{{ tool.id }}:{{ tool.barcode }}:{{ tool.name }}"
                                            class="p-3 hover:bg-gray-50 cursor-pointer">
                                        {{ tool.name }} (#{{ tool.barcode }})
                                        {% if tool.current_status == 'lent' %}
                                            - Ausgeliehen
                                        {% elif tool.current_status == 'defect' %}
                                            - Defekt
                                        {% else %}
                                            - Verfügbar
                                        {% endif %}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Verbrauchsmaterial-Liste -->
                        <div id="consumablesList" class="h-96 overflow-hidden bg-white rounded-lg shadow hidden">
                            <div class="p-4 border-b">
                                <h3 class="font-semibold">Verbrauchsmaterial</h3>
                            </div>
                            <select size="10" 
                                    id="consumableSelect"
                                    onchange="ManualLending.selectItem(this.value)"
                                    class="w-full h-[calc(100%-4rem)] overflow-y-auto p-2">
                                {% for item in consumables %}
                                    <option value="consumable:{{ item.id }}:{{ item.barcode }}:{{ item.name }}"
                                            class="p-3 hover:bg-gray-50 cursor-pointer">
                                        {{ item.name }} ({{ item.quantity }} Stk)
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mittlere Spalte: Mitarbeiter-Auswahl -->
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
            <div class="flex gap-4">
                <!-- Platzhalter für Symmetrie -->
                <div class="w-[52px]"></div>

                <div class="flex-1">
                    <h2 class="card-title mb-4">Mitarbeiter auswählen</h2>

                    <!-- Mitarbeiter Details -->
                    <div id="workerDetails" class="mb-4 p-4 bg-base-200 rounded-lg hidden">
                        <h3 class="font-bold mb-2" id="workerDetailName"></h3>
                        <div class="text-sm space-y-1">
                            <p>Abteilung: <span id="workerDetailDepartment"></span></p>
                            <p>Barcode: <span id="workerDetailBarcode"></span></p>
                        </div>
                    </div>

                    <!-- Mitarbeiter-Suche -->
                    <div class="form-control">
                        <input type="text" 
                               id="workerSearch" 
                               placeholder="Mitarbeiter suchen..." 
                               class="input input-bordered mb-4">

                        <!-- Mitarbeiter-Liste -->
                        <div class="h-96 overflow-hidden bg-white rounded-lg shadow">
                            <div class="p-4 border-b">
                                <h3 class="font-semibold">Mitarbeiter</h3>
                            </div>
                            <select size="10" 
                                    id="workerSelect"
                                    onchange="ManualLending.selectWorker(this.value)"
                                    class="w-full h-[calc(100%-4rem)] overflow-y-auto p-2">
                                {% for worker in workers %}
                                    <option value="worker:{{ worker.barcode }}:{{ worker.firstname }}:{{ worker.lastname }}:{{ worker.department }}"
                                            class="p-3 hover:bg-gray-50 cursor-pointer">
                                        {{ worker.firstname }} {{ worker.lastname }}
                                        {% if worker.department %}({{ worker.department }}){% endif %}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Rechte Spalte: Vorschau und Bestätigung -->
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
            <div class="flex gap-4">
                <!-- Platzhalter für Symmetrie -->
                <div class="w-[52px]"></div>

                <div class="flex-1">
                    <h2 class="card-title mb-4">Ausleihe bestätigen</h2>

                    <!-- Vorschau -->
                    <div class="bg-base-200 p-4 rounded-lg mb-6">
                        <h3 class="font-bold mb-4">Zusammenfassung</h3>
                        
                        <!-- Item Vorschau -->
                        <div class="mb-4">
                            <p class="text-sm font-medium text-gray-500">Artikel</p>
                            <div id="previewItem">Kein Artikel ausgewählt</div>
                        </div>
                        
                        <!-- Mengenfeld (nur für Verbrauchsmaterial) -->
                        <div id="amountField" class="mb-4 hidden">
                            <label class="text-sm font-medium text-gray-500">Menge</label>
                            <input type="number" 
                                   id="amount" 
                                   class="input input-bordered w-full" 
                                   value="1" 
                                   min="1">
                        </div>
                        
                        <!-- Worker Vorschau -->
                        <div class="mb-4">
                            <p class="text-sm font-medium text-gray-500">Mitarbeiter</p>
                            <div id="previewWorker">Kein Mitarbeiter ausgewählt</div>
                        </div>
                    </div>

                    <!-- Bestätigungs-Button -->
                    <button id="confirmButton" 
                            class="btn btn-primary w-full" 
                            onclick="ManualLending.processLending()"
                            disabled>
                        Ausleihe bestätigen
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Ersetzen Sie den Bereich für aktuelle Ausleihen mit dieser Version -->
<div class="mt-8">
    <h2 class="text-xl font-semibold mb-4">Aktuelle Ausleihen</h2>
    <!-- Filter Controls -->
    <div class="flex gap-4 mb-4">
        <select id="categoryFilter" class="select select-bordered">
            <option value="">Alle Kategorien</option>
            <option value="Werkzeug">Werkzeuge</option>
            <option value="Verbrauchsmaterial">Verbrauchsmaterial</option>
        </select>
        <input type="text" 
               id="searchInput" 
               placeholder="Suchen..." 
               class="input input-bordered">
    </div>
    
    {% if current_lendings %}
    <div class="overflow-x-auto">
        <table class="min-w-full table-auto" id="lendingsTable">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-4 py-2 text-left cursor-pointer" data-sort="item">
                        Artikel
                        <i class="fas fa-sort ml-1"></i>
                    </th>
                    <th class="px-4 py-2 text-left">Barcode</th>
                    <th class="px-4 py-2 text-left cursor-pointer" data-sort="worker">
                        Ausgeliehen/Ausgegeben an
                        <i class="fas fa-sort ml-1"></i>
                    </th>
                    <th class="px-4 py-2 text-left">Mitarbeiter-Barcode</th>
                    <th class="px-4 py-2 text-left cursor-pointer" data-sort="date">
                        Datum
                        <i class="fas fa-sort ml-1"></i>
                    </th>
                    <th class="px-4 py-2 text-left">Kategorie</th>
                    <th class="px-4 py-2 text-left">Menge</th>
                    <th class="px-4 py-2 text-left">Aktionen</th>
                </tr>
            </thead>
            <tbody>
                {% for lending in current_lendings %}
                <tr class="border-t">
                    <td class="px-4 py-2">{{ lending.item_name }}</td>
                    <td class="px-4 py-2">{{ lending.item_barcode }}</td>
                    <td class="px-4 py-2">{{ lending.worker_name }}</td>
                    <td class="px-4 py-2">{{ lending.worker_barcode }}</td>
                    <td class="px-4 py-2">
                        {% if lending.category == 'Werkzeug' %}
                            Ausgeliehen am {{ lending.action_date }}
                        {% else %}
                            Ausgegeben am {{ lending.action_date }}
                        {% endif %}
                    </td>
                    <td class="px-4 py-2">{{ lending.category }}</td>
                    <td class="px-4 py-2">
                        {% if lending.category == 'Verbrauchsmaterial' %}
                            {{ lending.amount }} Stk
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td class="px-4 py-2">
                        {% if lending.category == 'Werkzeug' %}
                        <button onclick="returnTool('{{ lending.item_barcode }}')"
                                class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded">
                            Rückgabe
                        </button>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p class="text-gray-600">Keine aktiven Ausleihen vorhanden.</p>
    {% endif %}
</div>

<script>
'use strict';

// Namespace für die manuelle Ausleihe
const ManualLending = {
    selectedItem: null,
    selectedWorker: null,
    currentType: 'tools',

    init() {
        this.setup();
    },

    setup() {
        this.setupEventListeners();
    },

    setupEventListeners() {
        // Suche in Listen
        const itemSearch = document.getElementById('itemSearch');
        if (itemSearch) {
            itemSearch.addEventListener('input', (e) => this.filterList(e.target.value));
        }

        const workerSearch = document.getElementById('workerSearch');
        if (workerSearch) {
            workerSearch.addEventListener('input', (e) => this.filterWorkers(e.target.value));
        }
    },

    selectItem(itemValue) {
        if (!itemValue) return;
        
        const [type, id, barcode, name] = itemValue.split(':');
        this.selectedItem = { type, id, barcode, name };
        
        // Mengenfeld anzeigen/verstecken je nach Typ
        const amountField = document.getElementById('amountField');
        if (amountField) {
            amountField.classList.toggle('hidden', type !== 'consumable');
        }
        
        this.updatePreview();
        this.updateItemDetails();
    },

    selectWorker(workerValue) {
        if (!workerValue) return;
        
        const [type, barcode, firstname, lastname, department] = workerValue.split(':');
        const name = `${firstname} ${lastname}${department ? ` (${department})` : ''}`;
        
        console.log('Worker ausgewählt:', { type, barcode, name, department });
        
        this.selectedWorker = {
            barcode: barcode,
            name: name,
            department: department
        };
        
        this.updatePreview();
        this.updateWorkerDetails();
    },

    updateItemDetails() {
        const details = document.getElementById('itemDetails');
        const name = document.getElementById('itemDetailName');
        const barcode = document.getElementById('itemDetailBarcode');
        const quantity = document.getElementById('itemDetailQuantity');
        
        if (this.selectedItem) {
            details.classList.remove('hidden');
            name.textContent = this.selectedItem.name;
            barcode.textContent = this.selectedItem.barcode;
            
            // Zeige Bestandsinfo nur bei Verbrauchsmaterial
            if (quantity) {
                quantity.classList.toggle('hidden', this.selectedItem.type !== 'consumable');
            }
        } else {
            details.classList.add('hidden');
        }
    },

    updateWorkerDetails() {
        const details = document.getElementById('workerDetails');
        const name = document.getElementById('workerDetailName');
        const barcode = document.getElementById('workerDetailBarcode');
        const department = document.getElementById('workerDetailDepartment');
        
        if (this.selectedWorker) {
            details.classList.remove('hidden');
            name.textContent = this.selectedWorker.name;
            barcode.textContent = this.selectedWorker.barcode;
            if (department) {
                department.textContent = this.selectedWorker.department || '-';
            }
        } else {
            details.classList.add('hidden');
        }
    },

    updatePreview() {
        const previewItem = document.getElementById('previewItem');
        const previewWorker = document.getElementById('previewWorker');
        const confirmButton = document.getElementById('confirmButton');
        
        if (previewItem) {
            previewItem.textContent = this.selectedItem ? 
                `${this.selectedItem.name} (${this.selectedItem.barcode})` : 
                'Kein Artikel ausgewählt';
        }
        if (previewWorker) {
            previewWorker.textContent = this.selectedWorker ? 
                this.selectedWorker.name : 
                'Kein Mitarbeiter ausgewählt';
        }
        if (confirmButton) {
            confirmButton.disabled = !(this.selectedItem && this.selectedWorker);
        }
    },

    filterList(searchTerm) {
        const select = this.currentType === 'tools' ? 'toolSelect' : 'consumableSelect';
        const options = document.getElementById(select).options;
        
        for (let option of options) {
            const text = option.text.toLowerCase();
            option.style.display = text.includes(searchTerm.toLowerCase()) ? '' : 'none';
        }
    },

    filterWorkers(searchTerm) {
        const options = document.getElementById('workerSelect').options;
        
        for (let option of options) {
            const text = option.text.toLowerCase();
            option.style.display = text.includes(searchTerm.toLowerCase()) ? '' : 'none';
        }
    },

    async processLending() {
        if (!this.selectedItem || !this.selectedWorker) {
            alert('Bitte wählen Sie einen Artikel und einen Mitarbeiter aus');
            return;
        }

        try {
            const formData = new FormData();
            formData.append('tool_barcode', this.selectedItem.barcode);
            formData.append('worker_barcode', this.selectedWorker.barcode);
            formData.append('action', 'lend');
            
            // Menge für Verbrauchsmaterial hinzufügen
            if (this.selectedItem.type === 'consumable') {
                const amount = document.getElementById('amount').value;
                if (!amount || amount < 1) {
                    alert('Bitte geben Sie eine gültige Menge ein');
                    return;
                }
                formData.append('quantity', amount);
            }

            console.log('Sende Ausleihe:', {
                tool: this.selectedItem.barcode,
                worker: this.selectedWorker.barcode
            });

            const response = await fetch(window.location.pathname, {
                method: 'POST',
                body: formData
            });

            if (response.redirected) {
                window.location.href = response.url;
                return;
            }
            
            const result = await response.json();
            if (result.success) {
                window.location.reload();
            } else {
                alert(result.message || 'Ein Fehler ist aufgetreten');
            }
        } catch (error) {
            console.error('Fehler bei der Ausleihe:', error);
            alert(`Fehler bei der Ausleihe: ${error.message}`);
        }
    },

    switchType(type) {
        console.log('Switching to type:', type);
        this.currentType = type;
        
        // Buttons aktualisieren
        document.querySelectorAll('[data-tab]').forEach(btn => {
            btn.classList.remove('btn-active');
        });
        document.querySelector(`[data-tab="${type}"]`).classList.add('btn-active');
        
        // Listen umschalten
        const toolsList = document.getElementById('toolsList');
        const consumablesList = document.getElementById('consumablesList');
        const amountField = document.getElementById('amountField');
        
        if (toolsList && consumablesList) {
            if (type === 'tools') {
                toolsList.classList.remove('hidden');
                consumablesList.classList.add('hidden');
                if (amountField) amountField.classList.add('hidden');
            } else {
                toolsList.classList.add('hidden');
                consumablesList.classList.remove('hidden');
                if (amountField) amountField.classList.remove('hidden');
            }

            // Auswahl zurücksetzen
            this.selectedItem = null;
            this.updatePreview();
            
            const toolSelect = document.getElementById('toolSelect');
            const consumableSelect = document.getElementById('consumableSelect');
            if (toolSelect) toolSelect.selectedIndex = -1;
            if (consumableSelect) consumableSelect.selectedIndex = -1;
        }
    }
};

// Globales Objekt erstellen
window.ManualLending = ManualLending;

// Initialisierung starten
document.addEventListener('DOMContentLoaded', () => {
    ManualLending.init();
});

function returnTool(barcode) {
    const formData = new FormData();
    formData.append('tool_barcode', barcode);
    formData.append('action', 'return');
    formData.append('worker_barcode', ''); // Leerer String für Rückgabe
    
    fetch('/admin/manual-lending', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            window.location.reload();
        } else {
            alert(result.message || 'Ein Fehler ist aufgetreten');
        }
    })
    .catch(error => {
        console.error('Fehler bei der Rückgabe:', error);
        alert(`Fehler bei der Rückgabe: ${error.message}`);
    });
}
</script>

<style>
/* Aktiver Button-Zustand */
.btn-active {
    @apply bg-primary text-primary-content;
}

/* Hover-Effekt für inaktive Buttons */
.btn-square:not(.btn-active):hover {
    @apply bg-base-200;
}
</style>
{% endblock %}