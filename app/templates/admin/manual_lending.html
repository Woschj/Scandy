{% extends "base.html" %}

{% block title %}Manuelle Ausleihe{% endblock %}

{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Linke Spalte: Verfügbare Items -->
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
            <h2 class="card-title">Verfügbare Items</h2>
            
            <!-- Tabs für Item-Typen -->
            <div class="tabs tabs-boxed mb-4">
                <button class="tab tab-active" onclick="switchTab('tools')">Werkzeuge</button>
                <button class="tab" onclick="switchTab('consumables')">Verbrauchsmaterial</button>
            </div>
            
            <!-- Suchfeld -->
            <div class="form-control mb-4">
                <input type="text" id="itemSearch" 
                       placeholder="Suchen..." 
                       class="input input-bordered">
            </div>
            
            <!-- Drag-Container für Items -->
            <div id="toolsList" class="space-y-2">
                {% for tool in tools %}
                <div class="draggable-item bg-base-200 p-3 rounded-lg cursor-move"
                     draggable="true"
                     data-type="tool"
                     data-id="{{ tool.id }}"
                     data-barcode="{{ tool.barcode }}"
                     data-name="{{ tool.name }}">
                    <span class="font-medium">{{ tool.name }}</span>
                    <span class="text-sm text-gray-500 block">{{ tool.barcode }}</span>
                </div>
                {% endfor %}
            </div>
            
            <div id="consumablesList" class="space-y-2 hidden">
                {% for consumable in consumables %}
                <div class="draggable-item bg-base-200 p-3 rounded-lg cursor-move"
                     draggable="true"
                     data-type="consumable"
                     data-id="{{ consumable.id }}"
                     data-barcode="{{ consumable.barcode }}"
                     data-name="{{ consumable.name }}">
                    <span class="font-medium">{{ consumable.name }}</span>
                    <span class="text-sm text-gray-500 block">Bestand: {{ consumable.quantity }}</span>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Mittlere Spalte: Drop-Zonen -->
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
            <h2 class="card-title mb-4">Neue Ausleihe</h2>
            
            <!-- Drop-Zone für Item -->
            <div id="itemDropZone" 
                 class="drop-zone bg-base-200 p-4 rounded-lg mb-4 min-h-[100px] border-2 border-dashed border-primary">
                <div class="text-center text-gray-500" id="itemDropText">
                    Werkzeug/Material hier ablegen
                </div>
                <div id="selectedItem" class="hidden bg-primary bg-opacity-10 p-2 rounded">
                    <span id="selectedItemName"></span>
                </div>
            </div>
            
            <!-- Drop-Zone für Mitarbeiter -->
            <div id="workerDropZone"
                 class="drop-zone bg-base-200 p-4 rounded-lg mb-4 min-h-[100px] border-2 border-dashed border-secondary">
                <div class="text-center text-gray-500" id="workerDropText">
                    Mitarbeiter hier ablegen
                </div>
                <div id="selectedWorker" class="hidden bg-secondary bg-opacity-10 p-2 rounded">
                    <span id="selectedWorkerName"></span>
                </div>
            </div>
            
            <!-- Ausleihe-Button -->
            <button id="confirmLending" 
                    class="btn btn-primary w-full mt-4" 
                    disabled>
                Ausleihe bestätigen
            </button>
        </div>
    </div>

    <!-- Rechte Spalte: Mitarbeiter -->
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
            <h2 class="card-title">Mitarbeiter</h2>
            
            <!-- Mitarbeiter-Suche -->
            <div class="form-control mb-4">
                <input type="text" id="workerSearch" 
                       placeholder="Mitarbeiter suchen..." 
                       class="input input-bordered">
            </div>
            
            <!-- Mitarbeiter-Liste -->
            <div id="workersList" class="space-y-2">
                {% for worker in workers %}
                <div class="draggable-item bg-base-200 p-3 rounded-lg cursor-move"
                     draggable="true"
                     data-type="worker"
                     data-id="{{ worker.id }}"
                     data-barcode="{{ worker.barcode }}"
                     data-name="{{ worker.firstname }} {{ worker.lastname }}">
                    <span class="font-medium">{{ worker.firstname }} {{ worker.lastname }}</span>
                    <span class="text-sm text-gray-500 block">{{ worker.department }}</span>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
let selectedItem = null;
let selectedWorker = null;

document.addEventListener('DOMContentLoaded', function() {
    console.log("Initialisiere Drag & Drop...");
    
    // Alle draggable Elemente
    const draggableItems = document.querySelectorAll('.draggable-item');
    console.log(`Gefundene draggable Items: ${draggableItems.length}`);
    
    draggableItems.forEach(item => {
        item.setAttribute('draggable', 'true');
        
        item.addEventListener('dragstart', function(e) {
            console.log('Dragstart:', e.target.dataset);
            e.target.classList.add('opacity-50');
            e.dataTransfer.setData('application/json', JSON.stringify({
                type: e.target.dataset.type,
                id: e.target.dataset.id,
                barcode: e.target.dataset.barcode,
                name: e.target.dataset.name
            }));
        });
        
        item.addEventListener('dragend', function(e) {
            console.log('Dragend');
            e.target.classList.remove('opacity-50');
        });
    });

    // Drop-Zonen
    const dropZones = document.querySelectorAll('.drop-zone');
    console.log(`Gefundene Drop-Zonen: ${dropZones.length}`);
    
    dropZones.forEach(zone => {
        zone.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.stopPropagation();
            zone.classList.add('border-primary', 'bg-primary', 'bg-opacity-10');
        });
        
        zone.addEventListener('dragleave', function(e) {
            e.preventDefault();
            e.stopPropagation();
            zone.classList.remove('border-primary', 'bg-primary', 'bg-opacity-10');
        });
        
        zone.addEventListener('drop', function(e) {
            console.log('Drop event triggered');
            e.preventDefault();
            e.stopPropagation();
            
            zone.classList.remove('border-primary', 'bg-primary', 'bg-opacity-10');
            
            try {
                const data = JSON.parse(e.dataTransfer.getData('application/json'));
                console.log('Dropped data:', data);
                
                if (zone.id === 'itemDropZone' && (data.type === 'tool' || data.type === 'consumable')) {
                    selectedItem = data;
                    document.getElementById('itemDropText').classList.add('hidden');
                    const selectedDiv = document.getElementById('selectedItem');
                    selectedDiv.classList.remove('hidden');
                    selectedDiv.querySelector('#selectedItemName').textContent = data.name;
                }
                else if (zone.id === 'workerDropZone' && data.type === 'worker') {
                    selectedWorker = data;
                    document.getElementById('workerDropText').classList.add('hidden');
                    const selectedDiv = document.getElementById('selectedWorker');
                    selectedDiv.classList.remove('hidden');
                    selectedDiv.querySelector('#selectedWorkerName').textContent = data.name;
                }
                
                updateConfirmButton();
            } catch (error) {
                console.error('Fehler beim Verarbeiten der Drop-Daten:', error);
            }
        });
    });
    
    // Tab-Funktionalität
    document.querySelectorAll('.tabs .tab').forEach(tab => {
        tab.addEventListener('click', function(e) {
            const targetTab = this.getAttribute('data-tab');
            console.log(`Tab gewechselt zu: ${targetTab}`);
            
            // Tabs umschalten
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('tab-active'));
            this.classList.add('tab-active');
            
            // Listen umschalten
            document.getElementById('toolsList').classList.toggle('hidden', targetTab !== 'tools');
            document.getElementById('consumablesList').classList.toggle('hidden', targetTab !== 'consumables');
        });
    });
    
    // Suchfunktionalität
    initSearch();
});

function updateConfirmButton() {
    const button = document.getElementById('confirmLending');
    button.disabled = !(selectedItem && selectedWorker);
    if (selectedItem && selectedWorker) {
        button.classList.add('btn-primary');
    } else {
        button.classList.remove('btn-primary');
    }
}

function initSearch() {
    document.getElementById('itemSearch').addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase();
        document.querySelectorAll('#toolsList .draggable-item, #consumablesList .draggable-item').forEach(item => {
            const name = item.dataset.name.toLowerCase();
            item.style.display = name.includes(searchTerm) ? '' : 'none';
        });
    });
    
    document.getElementById('workerSearch').addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase();
        document.querySelectorAll('#workersList .draggable-item').forEach(item => {
            const name = item.dataset.name.toLowerCase();
            item.style.display = name.includes(searchTerm) ? '' : 'none';
        });
    });
}

// Ausleihe verarbeiten
document.getElementById('confirmLending').addEventListener('click', function() {
    if (!selectedItem || !selectedWorker) return;
    
    let amount = 1;
    if (selectedItem.type === 'consumable') {
        amount = prompt('Menge eingeben:', '1');
        if (!amount) return;
        amount = parseInt(amount);
    }
    
    fetch('/api/lending/process', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            item_type: selectedItem.type,
            item_barcode: selectedItem.barcode,
            worker_barcode: selectedWorker.barcode,
            amount: amount
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert(data.message || 'Fehler bei der Ausleihe');
        }
    })
    .catch(error => {
        console.error('Fehler:', error);
        alert('Fehler bei der Ausleihe');
    });
});
</script>
{% endblock %}