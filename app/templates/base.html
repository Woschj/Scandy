<!DOCTYPE html>
<html lang="de" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>{% block title %}{% endblock %} - Werkzeugverwaltung</title>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind und DaisyUI CSS -->
    <link href="https://cdn.jsdelivr.net/npm/daisyui@3.9.4/dist/full.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Tailwind Konfiguration -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            },
            daisyui: {
                themes: [
                    "light",
                    "dark",
                    "corporate",
                    "business",
                    "professional",
                    "modern",
                    "night",
                    "forest",
                    "autumn"
                ],
            }
        }
    </script>

    <style>
        @keyframes scan {
            0% { 
                background: linear-gradient(90deg, transparent, var(--primary-color), transparent);
            }
            50% { 
                background: linear-gradient(90deg, transparent, var(--primary-color), transparent);
            }
            100% { 
                background: linear-gradient(90deg, transparent, var(--primary-color), transparent);
            }
        }

        .scan-animation {
            position: relative;
            height: 2px;
            background: #eee;
            overflow: hidden;
            margin: 1rem 0;
            border-radius: 1px;
        }

        .scan-line {
            position: absolute;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, var(--primary-color), transparent);
            animation: scan 3s ease-in-out infinite;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
        }
        
        .link-primary {
            @apply text-[#5b69a7] hover:text-[#4c5789] font-medium transition-colors duration-200;
        }
        
        .table-link {
            @apply link-primary no-underline hover:underline;
        }

        /* Dark mode Anpassungen */
        [data-theme='dark'] .scan-animation {
            background: #2a303c;
        }
        
        [data-theme='dark'] .scan-line {
            background: linear-gradient(90deg, transparent, #a6adba, transparent);
        }

        :root {
            --primary-color: {{ colors.primary|default('#5b69a7') }};
            --secondary-color: {{ colors.secondary|default('#4c5789') }};
            --accent-color: {{ colors.accent|default('#3d4675') }};
        }

        .btn-primary {
            background-color: var(--primary-color) !important;
            border-color: var(--primary-color) !important;
        }
        .btn-primary:hover {
            background-color: var(--secondary-color) !important;
            border-color: var(--secondary-color) !important;
        }
        
        .table-link {
            color: var(--primary-color);
        }
        .table-link:hover {
            color: var(--secondary-color);
        }

        /* Weitere Farbanpassungen */
        .text-primary {
            color: var(--primary-color) !important;
        }
        .bg-primary {
            background-color: var(--primary-color) !important;
        }
        .border-primary {
            border-color: var(--primary-color) !important;
        }
    </style>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
</head>

<body class="min-h-screen bg-base-200">
    <div class="drawer">
        <input id="drawer-toggle" type="checkbox" class="drawer-toggle" />
        <div class="drawer-content flex flex-col">
            <!-- Navbar -->
            <div class="navbar bg-base-100 shadow-lg px-4 relative">
                <!-- Linke Seite -->
                <div class="flex-1">
                    <!-- Logo -->
                    <a href="{{ url_for(routes.TOOLS_INDEX) }}" class="flex items-center">
                        <img src="{{ url_for('static', filename='images/scandy-logo.svg') }}" 
                             alt="Scandy Logo" 
                             class="h-12 w-auto"
                             style="min-width: 120px; object-fit: contain;">
                    </a>
                    
                    <!-- Hauptmenü (Desktop) -->
                    <div class="hidden lg:flex ml-4">
                        <a href="{{ url_for('inventory.tools') }}" 
                           class="btn btn-ghost {% if request.endpoint == routes.TOOLS_INDEX %}btn-active{% endif %}">
                            <i class="fas fa-tools mr-2"></i>Werkzeuge
                        </a>
                        <a href="{{ url_for('inventory.consumables') }}" 
                           class="btn btn-ghost {% if request.endpoint == routes.CONSUMABLES_INDEX %}btn-active{% endif %}">
                            <i class="fas fa-box-open mr-2"></i>Verbrauchsmaterial
                        </a>
                        <a href="{{ url_for('inventory.workers') }}"
                           class="btn btn-ghost {% if request.endpoint == routes.WORKERS_INDEX %}btn-active{% endif %}">
                            <i class="fas fa-users mr-2"></i>Mitarbeiter
                        </a>
                    </div>
                </div>

                <!-- QuickScan Button (Mittig) -->
                <button onclick="showQuickScan()" 
                        class="btn btn-circle btn-primary text-white"
                        style="transform: translate(-50%, 0) scale(1.5);">
                    <i class="fas fa-barcode"></i>
                </button>

                <!-- Rechte Seite -->
                <div class="flex-none">
                    <div class="hidden lg:flex items-center gap-4">
                        {% if session.get('is_admin') %}
                        <a href="{{ url_for(routes.ADMIN_MANUAL_LENDING) }}" 
                           class="btn btn-ghost {% if request.endpoint == routes.ADMIN_MANUAL_LENDING %}btn-active{% endif %}">
                            <i class="fas fa-hand-holding mr-2"></i>Manuelle Ausleihe
                        </a>
                        <a href="{{ url_for(routes.ADMIN_DASHBOARD) }}" 
                           class="btn btn-ghost {% if request.endpoint == routes.ADMIN_DASHBOARD %}btn-active{% endif %}">
                            <i class="fas fa-chart-line mr-2"></i>Dashboard
                        </a>
                        {% endif %}

                        <!-- Theme Toggle -->
                        <label class="swap swap-rotate btn btn-ghost btn-circle">
                            <input type="checkbox" class="theme-controller" value="dark" />
                            <i class="fas fa-sun swap-on"></i>
                            <i class="fas fa-moon swap-off"></i>
                        </label>

                        <!-- Login/Logout -->
                        {% if session.get('logged_in') %}
                        <a href="{{ url_for(routes.LOGOUT) }}" class="btn btn-ghost">
                            <i class="fas fa-sign-out-alt mr-2"></i>Logout
                        </a>
                        {% else %}
                        <a href="{{ url_for(routes.LOGIN) }}" class="btn btn-ghost">
                            <i class="fas fa-sign-in-alt mr-2"></i>Login
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Mobile Drawer -->
            <div class="drawer-side z-30">
                <label for="drawer-toggle" class="drawer-overlay"></label>
                <ul class="menu p-4 w-80 h-full bg-base-200 gap-2">
                    {% if session.get('is_admin') %}
                    <li>
                        <a href="{{ url_for(routes.ADMIN_DASHBOARD) }}"
                           class="{% if request.endpoint == routes.ADMIN_DASHBOARD %}active{% endif %}">
                            <i class="fas fa-chart-line"></i>Dashboard
                        </a>
                    </li>
                    {% endif %}
                    <li>
                        <a href="{{ url_for('index.index') }}" 
                           class="{% if request.endpoint == routes.INDEX %}active{% endif %}">
                            <i class="fas fa-home"></i>Start
                        </a>
                    </li>
                    <li>
                        <a href="{{ url_for('inventory.tools') }}" 
                           class="{% if request.endpoint == routes.TOOLS_INDEX %}active{% endif %}">
                            <i class="fas fa-tools"></i>Werkzeuge
                        </a>
                    </li>
                    <li>
                        <a href="{{ url_for('inventory.consumables') }}" 
                           class="{% if request.endpoint == routes.CONSUMABLES_INDEX %}active{% endif %}">
                            <i class="fas fa-box-open"></i>Verbrauchsmaterial
                        </a>
                    </li>
                    <li>
                        <a href="{{ url_for('inventory.workers') }}"
                           class="{% if request.endpoint == routes.WORKERS_INDEX %}active{% endif %}">
                            <i class="fas fa-users"></i>Mitarbeiter
                        </a>
                    </li>
                    {% if session.get('is_admin') %}
                    <li>
                        <a href="{{ url_for(routes.ADMIN_MANUAL_LENDING) }}"
                           class="{% if request.endpoint == routes.ADMIN_MANUAL_LENDING %}active{% endif %}">
                            <i class="fas fa-hand-holding"></i>Manuelle Ausleihe
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </div>

            <!-- Main Content -->
            <main class="container mx-auto px-4 py-8 relative z-0">
                {% block content %}{% endblock %}
            </main>
        </div>
    </div>

    <!-- QuickScan Modal -->
    <dialog id="quickScanModal" class="modal">
        <form method="dialog" class="modal-box relative max-w-2xl overflow-y-auto max-h-[90vh] z-40">
            <!-- Verstecktes Input-Feld -->
            <input type="text" 
                   id="main-scanner-input"
                   class="w-0 h-0 opacity-0 absolute"
                   autocomplete="off">
            
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-2xl">QuickScan</h3>
                <button class="btn btn-sm btn-circle" onclick="resetQuickScan()">✕</button>
            </div>

            <!-- Scan Steps -->
            <div id="scan-steps" class="mb-6">
                <!-- Step 1: Werkzeug -->
                <div id="step-tool" class="scan-step">
                    <div class="text-center mb-6">
                        <i class="fas fa-tools text-5xl text-primary mb-4"></i>
                        <h4 class="text-xl font-bold mb-2">Werkzeug scannen</h4>
                        <p class="text-sm opacity-70">Bitte scannen Sie den Barcode des Werkzeugs</p>
                    </div>
                    <div id="tool-preview" class="rounded-xl transition-all duration-300">
                        <div class="text-center">
                            <p class="font-bold text-xl">---</p>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Mitarbeiter -->
                <div id="step-worker" class="scan-step" style="display: none;">
                    <div class="text-center mb-6">
                        <i class="fas fa-user text-5xl text-primary mb-4"></i>
                        <h4 class="text-xl font-bold mb-2">Mitarbeiter scannen</h4>
                        <p class="text-sm opacity-70">Bitte scannen Sie den Mitarbeiterausweis</p>
                    </div>
                    <div id="worker-preview" class="bg-base-200 rounded-xl p-6">
                        <div class="text-center">
                            <p class="font-bold text-xl">---</p>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Bestätigung -->
                <div id="step-confirm" class="scan-step" style="display: none;">
                    <!-- Wird dynamisch gefüllt -->
                </div>
            </div>

            <!-- Scan Animation -->
            <div class="scan-animation">
                <div class="scan-line"></div>
            </div>
        </form>
    </dialog>

    <!-- QR-Code Modal -->
    <div id="qrModal" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg mb-4">QuickScan QR-Code</h3>
            <div class="flex justify-center mb-4">
                <div id="qrcode"></div>
            </div>
            <p class="text-center text-sm mb-4">Scannen Sie diesen Code mit dem Barcodescanner, um den QuickScan zu starten</p>
            <div class="modal-action">
                <button class="btn" onclick="closeQRModal()">Schließen</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/@zxing/library@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode.js@1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/daisyui@latest/dist/full.bundle.min.js"></script>
    <script>
    function getFilterColumnIndex(filterType) {
        const path = window.location.pathname;
        
        // Mapping für verschiedene Seiten
        const columnMaps = {
            '/workers': {
                'filter_abteilung': 1,  // Spalte für Abteilung
                'filter_status': 2      // Spalte für Status
            },
            '/consumables': {
                'filter_typ': 1,        // Spalte für Typ
                'filter_ort': 2,        // Spalte für Ort
                'filter_status': 3      // Spalte für Status
            },
            '/': {                      // Werkzeuge (index)
                'filter_ort': 1,        // Spalte für Ort
                'filter_typ': 2,        // Spalte für Typ
                'filter_status': 3      // Spalte für Status
            }
        };

        // Wähle das richtige Mapping basierend auf dem Pfad
        const mapping = columnMaps[path] || columnMaps['/'];
        return mapping[filterType] ?? -1;
    }

    function filterAndSearch() {
        const searchText = document.getElementById('searchInput')?.value.toLowerCase() || '';
        const rows = document.querySelectorAll('tbody tr');
        const path = window.location.pathname;
        
        // Performance-Optimierung: Cache DOM-Selektionen
        const activeFilters = Array.from(document.querySelectorAll('select[name^="filter_"]'))
            .filter(select => select.value)
            .map(select => ({
                type: select.name,
                value: select.value.toLowerCase(),
                columnIndex: getFilterColumnIndex(select.name)
            }));

        // Batch-Verarbeitung für bessere Performance
        const updates = [];
        
        rows.forEach(row => {
            if (!row || !row.cells) return;
            
            // Suche
            const matchesSearch = searchText === '' || row.textContent.toLowerCase().includes(searchText);
            
            // Filter
            const matchesFilters = activeFilters.every(filter => {
                if (filter.columnIndex === -1) return true;
                const cell = row.cells[filter.columnIndex]; // Verwende cells statt children
                if (!cell) return true;
                return cell.textContent.trim().toLowerCase() === filter.value;
            });

            // Sammle Updates
            updates.push({
                element: row,
                display: matchesSearch && matchesFilters ? '' : 'none'
            });
        });

        // Batch-Update des DOM
        requestAnimationFrame(() => {
            updates.forEach(update => {
                update.element.style.display = update.display;
            });
        });
    }

    function initializeFilters() {
        const searchInput = document.getElementById('searchInput');
        const filterSelects = document.querySelectorAll('select[name^="filter_"]');
        
        // Suchfeld-Handler
        if (searchInput) {
            searchInput.addEventListener('input', () => {
                requestAnimationFrame(filterAndSearch);
            });
        }
        
        // Filter-Select-Handler
        filterSelects.forEach(select => {
            select.addEventListener('change', function() {
                const params = new URLSearchParams(window.location.search);
                filterSelects.forEach(sel => {
                    if (sel.value) {
                        params.set(sel.name, sel.value);
                    } else {
                        params.delete(sel.name);
                    }
                });
                window.location.href = `${window.location.pathname}?${params.toString()}`;
            });
        });

        // Setze gespeicherte Filter-Werte
        const params = new URLSearchParams(window.location.search);
        filterSelects.forEach(select => {
            const savedValue = params.get(select.name);
            if (savedValue) {
                select.value = savedValue;
            }
        });

        // Initial filtering
        requestAnimationFrame(filterAndSearch);
    }

    // Initialisierung nach dem Laden der Seite
    document.addEventListener('DOMContentLoaded', initializeFilters);

    // QuickScan Funktionen
    function showQuickScan() {
        const modal = document.getElementById('quickScanModal');
        if (modal) {
            modal.showModal();
            // Fokus auf das versteckte Input-Feld setzen
            setTimeout(() => {
                const input = document.getElementById('main-scanner-input');
                if (input) {
                    input.focus();
                }
            }, 100);
        }
    }

    function resetQuickScan() {
        const modal = document.getElementById('quickScanModal');
        if (modal) {
            modal.close();
        }
        // Reset der Scan-Schritte
        document.querySelectorAll('.scan-step').forEach(step => {
            if (step.id === 'step-tool') {
                step.style.display = 'block';
            } else {
                step.style.display = 'none';
            }
        });
        // Reset der Vorschau-Felder
        document.querySelector('#tool-preview .text-xl').textContent = '---';
        document.querySelector('#worker-preview .text-xl').textContent = '---';
    }

    // Event Listener für das Modal
    document.addEventListener('DOMContentLoaded', function() {
        const modal = document.getElementById('quickScanModal');
        const input = document.getElementById('main-scanner-input');
        
        if (modal && input) {
            // Automatischer Fokus beim Öffnen
            modal.addEventListener('show', () => {
                setTimeout(() => input.focus(), 100);
            });
            
            // Fokus wiederherstellen, wenn er verloren geht
            modal.addEventListener('click', () => {
                input.focus();
            });
        }
    });

    // Theme Management
    document.addEventListener('DOMContentLoaded', function() {
        // Theme aus localStorage laden oder System-Einstellung nutzen
        const savedTheme = localStorage.getItem('theme') || 
                          (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        
        // Theme initial setzen
        document.documentElement.setAttribute('data-theme', savedTheme);
        
        // Checkbox-Status setzen
        const themeToggle = document.querySelector('.theme-controller');
        if (themeToggle) {
            themeToggle.checked = savedTheme === 'dark';
        }

        // Theme Toggle Event Listener
        document.querySelector('.theme-controller')?.addEventListener('change', function(e) {
            const newTheme = e.target.checked ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        });
    });
    </script>
</body>
</html>