<!DOCTYPE html>
<html lang="de" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Scandy{% endblock %}</title>
    
    <!-- Tailwind (Produktionsversion) -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio"></script>
    
    <!-- DaisyUI -->
    <link href="https://cdn.jsdelivr.net/npm/daisyui@3.9.4/dist/full.css" rel="stylesheet" type="text/css" />
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Eigene Styles nach den Framework Styles -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/quickscan.css') }}">

    <script>
        tailwind.config = {
            theme: {
                extend: {}
            },
            daisyui: {
                themes: ["light"]
            }
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <script>
        mermaid.initialize({ startOnLoad: true });
    </script>
</head>

<body class="min-h-screen bg-base-200">
    <div class="flex flex-col min-h-screen">
        <!-- Vertikales Seitenmenü -->
        <div class="fixed left-0 top-0 h-full w-16 bg-base-300 flex flex-col items-center py-4 gap-2 shadow-lg z-50">
            <!-- Logo als QuickScan-Trigger -->
            <div class="w-16 h-16 rounded-full hover:rounded-xl overflow-hidden transition-all duration-300 flex items-center justify-center bg-base-100 cursor-pointer relative"
                 id="quickScanTrigger"
                 title="Quick Scan öffnen"
                 style="margin-top: -1.5rem;">
                <img src="{{ url_for('static', filename='images/scandy-logo.svg') }}" 
                     alt="Scandy Logo" 
                     class="w-14 h-14 object-contain">
                <!-- Scanner Animation -->
                <div class="absolute w-full h-0.5 bg-primary/50 -top-1 left-0 animate-scanner"></div>
            </div>
            
            <!-- Trennlinie -->
            <div class="w-8 h-0.5 bg-base-content/20 rounded-full"></div>
            
            <!-- Navigation Items -->
            <a href="{{ url_for('tools.index') }}" 
               class="w-12 h-12 rounded-3xl hover:rounded-xl flex items-center justify-center transition-all duration-300 
                      {% if 'tools' in request.endpoint %}bg-primary text-primary-content{% else %}hover:bg-base-100{% endif %}">
                <i class="fas fa-tools text-xl"></i>
            </a>
            
            <a href="{{ url_for('consumables.index') }}" 
               class="w-12 h-12 rounded-3xl hover:rounded-xl flex items-center justify-center transition-all duration-300 
                      {% if 'consumables' in request.endpoint %}bg-primary text-primary-content{% else %}hover:bg-base-100{% endif %}">
                <i class="fas fa-box-open text-xl"></i>
            </a>
            
            {% if session.get('is_admin') %}
            <a href="{{ url_for('workers.index') }}" 
               class="w-12 h-12 rounded-3xl hover:rounded-xl flex items-center justify-center transition-all duration-300
                      {% if 'workers' in request.endpoint %}bg-primary text-primary-content{% else %}hover:bg-base-100{% endif %}">
                <i class="fas fa-users text-xl"></i>
            </a>
            {% endif %}
        </div>

        <!-- Navbar -->
        <div class="navbar bg-base-100 shadow-lg px-4 relative ml-16">
            <!-- Linke Seite mit Titel -->
            <div class="flex-none">
                <h1 class="text-xl font-bold">
                    {% if 'tools' in request.endpoint %}Werkzeuge
                    {% elif 'workers' in request.endpoint %}Mitarbeiter
                    {% elif 'consumables' in request.endpoint %}Verbrauchsmaterial
                    {% elif request.endpoint == 'main.about' %}Über Scandy
                    {% else %}Dashboard{% endif %}
                </h1>
            </div>

            <!-- BTZ Logo zentriert -->
            <div class="flex-1 flex justify-center">
                <a href="{{ url_for('main.index') }}" class="absolute left-1/2 top-1/2 transform -translate-x-1/2 -translate-y-1/2 hover:opacity-80 transition-opacity">
                    <img src="{{ url_for('static', filename='images/BTZ_logo.jpg') }}" 
                         alt="BTZ Logo" 
                         class="h-10 object-contain">
                </a>
            </div>

            <!-- Rechte Seite -->
            <div class="flex-none">
                <div class="flex items-center gap-2">
                    {% if session.get('is_admin') %}
                    <div class="dropdown dropdown-end">
                        <label tabindex="0" class="btn btn-ghost btn-sm">
                            <i class="fas fa-bars"></i>
                        </label>
                        <ul tabindex="0" class="menu menu-sm dropdown-content mt-3 z-[1] p-2 shadow bg-base-100 rounded-box w-52">
                            <li>
                                <a href="{{ url_for('admin.manual_lending') }}" 
                                   class="{% if request.endpoint == 'admin.manual_lending' %}active{% endif %}">
                                    <i class="fas fa-hand-holding mr-2"></i>Manuelle Ausleihe
                                </a>
                            </li>
                            <li>
                                <a href="{{ url_for('admin.dashboard') }}" 
                                   class="{% if 'admin.dashboard' in request.endpoint %}active{% endif %}">
                                    <i class="fas fa-chart-line mr-2"></i>Dashboard
                                </a>
                            </li>
                            <li>
                                <a href="{{ url_for('main.about') }}" 
                                   class="{% if request.endpoint == 'main.about' %}active{% endif %}">
                                    <i class="fas fa-info-circle mr-2"></i>Über Scandy
                                </a>
                            </li>
                        </ul>
                    </div>
                    <a href="{{ url_for('admin.trash') }}" 
                       class="btn btn-ghost btn-circle btn-sm text-error relative">
                        <i class="fas fa-trash-alt"></i>
                        {% if trash_count is defined and trash_count > 0 %}
                        <span class="absolute -top-2 -right-2 bg-error text-white rounded-full w-5 h-5 
                                   flex items-center justify-center text-xs">
                            {{ trash_count }}
                        </span>
                        {% endif %}
                    </a>
                    <label class="swap swap-rotate btn btn-ghost btn-circle btn-sm">
                        <input type="checkbox" class="theme-controller" />
                        <i class="fas fa-sun swap-on"></i>
                        <i class="fas fa-moon swap-off"></i>
                    </label>
                    <a href="{{ url_for('auth.logout') }}" class="btn btn-ghost btn-circle btn-sm" title="Logout">
                        <i class="fas fa-sign-out-alt"></i>
                    </a>
                    {% else %}
                    <a href="{{ url_for('auth.login') }}" class="btn btn-ghost btn-sm">
                        <i class="fas fa-sign-in-alt mr-2"></i>Login
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <main class="container-fluid max-w-[95%] mx-auto px-4 py-8 relative z-0 overflow-x-hidden">
            <div class="overflow-auto h-[calc(100vh-8rem)]">
                {% block content %}{% endblock %}
            </div>
        </main>
    </div>

    <!-- QuickScan Modal -->
    {% if request.endpoint != 'quick_scan.quick_scan' %}
    {% include 'components/quickscan_modal.html' %}

    <!-- Skripte bereinigen - nur einmal einbinden -->
    <script src="https://unpkg.com/@zxing/library@latest"></script>
    <script src="{{ url_for('static', filename='js/toast.js') }}"></script>
    <script src="{{ url_for('static', filename='js/quickscan.js') }}"></script>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Logo-Klick Handler
        const quickScanTrigger = document.getElementById('quickScanTrigger');
        const quickScanModal = document.getElementById('quickScanModal');
        
        if (quickScanTrigger && quickScanModal) {
            quickScanTrigger.addEventListener('click', function() {
                quickScanModal.showModal();
                // Fokus auf Input nach kurzem Delay
                setTimeout(() => {
                    const input = document.getElementById('itemScanInput');
                    if (input) input.focus();
                }, 100);
            });
        }
    });
    </script>
    {% endif %}

    <!-- Zusätzliche Styles für Webcam-Scanning -->
    <style>
        .scan-line-camera {
            position: absolute;
            width: 100%;
            height: 2px;
            background: hsl(var(--p));
            animation: scanAnimation 2s linear infinite;
        }
        
        @keyframes scanAnimation {
            0% {
                top: 0;
            }
            50% {
                top: 100%;
            }
            100% {
                top: 0;
            }
        }
        
        #video {
            max-height: 300px;
            width: 100%;
            object-fit: cover;
        }
    </style>

    <!-- QR-Code Modal -->
    <div id="qrModal" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg mb-4">QuickScan QR-Code</h3>
            <div class="flex justify-center mb-4">
                <div id="qrcode"></div>
            </div>
            <p class="text-center text-sm mb-4">Scannen Sie diesen Code mit dem Barcodescanner, um den QuickScan zu starten</p>
            <div class="modal-action">
                <button class="btn" onclick="closeQRModal()">Schließen</button>
            </div>
        </div>
    </div>

    <!-- Externe Bibliotheken -->
    <script src="https://unpkg.com/@zxing/library@latest" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/daisyui@3.9.4/dist/full.css"></script>

    <!-- Eigene Services -->
    <script src="{{ url_for('static', filename='js/lending-service.js') }}" defer></script>

    <!-- Seiten-spezifische Scripts -->
    {% block scripts %}{% endblock %}

    <!-- Base Template Scripts -->
    <script defer>
    function getFilterColumnIndex(filterType) {
        const path = window.location.pathname;
        
        // Mapping für verschiedene Seiten
        const columnMaps = {
            '/workers': {
                'filter_abteilung': 1,  // Spalte für Abteilung
                'filter_status': 2      // Spalte für Status
            },
            '/consumables': {
                'filter_typ': 1,        // Spalte für Typ
                'filter_ort': 2,        // Spalte für Ort
                'filter_status': 3      // Spalte für Status
            },
            '/': {                      // Werkzeuge (index)
                'filter_ort': 1,        // Spalte für Ort
                'filter_typ': 2,        // Spalte für Typ
                'filter_status': 3      // Spalte für Status
            }
        };

        // Wähle das richtige Mapping basierend auf dem Pfad
        const mapping = columnMaps[path] || columnMaps['/'];
        return mapping[filterType] ?? -1;
    }

    function filterAndSearch() {
        try {
            const searchText = document.getElementById('searchInput')?.value.toLowerCase() || '';
            const rows = document.querySelectorAll('tbody tr');
            const path = window.location.pathname;
            
            // Performance-Optimierung: Cache DOM-Selektionen
            const activeFilters = Array.from(document.querySelectorAll('select[name^="filter_"]'))
                .filter(select => select.value)
                .map(select => ({
                    type: select.name,
                    value: select.value.toLowerCase(),
                    columnIndex: getFilterColumnIndex(select.name)
                }));

            // Batch-Verarbeitung für bessere Performance
            const updates = [];
            
            rows.forEach(row => {
                if (!row || !row.cells) return;
                
                // Suche
                const matchesSearch = searchText === '' || row.textContent.toLowerCase().includes(searchText);
                
                // Filter
                const matchesFilters = activeFilters.every(filter => {
                    if (filter.columnIndex === -1) return true;
                    const cell = row.cells[filter.columnIndex]; // Verwende cells statt children
                    if (!cell) return true;
                    return cell.textContent.trim().toLowerCase() === filter.value;
                });

                // Sammle Updates
                updates.push({
                    element: row,
                    display: matchesSearch && matchesFilters ? '' : 'none'
                });
            });

            // Batch-Update des DOM
            requestAnimationFrame(() => {
                updates.forEach(update => {
                    update.element.style.display = update.display;
                });
            });
        } catch (e) {
            console.error('Fehler beim Filtern:', e);
        }
    }

    function initializeFilters() {
        const searchInput = document.getElementById('searchInput');
        const filterSelects = document.querySelectorAll('select[name^="filter_"]');
        
        // Suchfeld-Handler
        if (searchInput) {
            searchInput.addEventListener('input', () => {
                requestAnimationFrame(filterAndSearch);
            });
        }
        
        // Filter-Select-Handler
        filterSelects.forEach(select => {
            select.addEventListener('change', function() {
                const params = new URLSearchParams(window.location.search);
                filterSelects.forEach(sel => {
                    if (sel.value) {
                        params.set(sel.name, sel.value);
                    } else {
                        params.delete(sel.name);
                    }
                });
                window.location.href = `${window.location.pathname}?${params.toString()}`;
            });
        });

        // Setze gespeicherte Filter-Werte
        const params = new URLSearchParams(window.location.search);
        filterSelects.forEach(select => {
            const savedValue = params.get(select.name);
            if (savedValue) {
                select.value = savedValue;
            }
        });

        // Initial filtering
        requestAnimationFrame(filterAndSearch);
    }

    // Initialisierung nach dem Laden der Seite
    document.addEventListener('DOMContentLoaded', initializeFilters);

    // Globale Variablen für den Scan-Status
    let currentStep = 'tool';  // Mögliche Werte: 'tool', 'worker', 'confirm'
    let scannedTool = null;
    let scannedWorker = null;

    function showQuickScan() {
        const modal = document.getElementById('quickScanModal');
        if (modal && typeof modal.showModal === 'function') {
            modal.showModal();
            resetQuickScan();
            focusScanInput();
        }
    }

    function closeQuickScan() {
        const modal = document.getElementById('quickScanModal');
        if (modal) {
            modal.close();
            // Stelle sicher, dass der Scroll-Position zurückgesetzt wird
            window.scrollTo(0, 0);
        }
    }

    function resetQuickScan() {
        currentStep = 'tool';
        scannedTool = null;
        scannedWorker = null;
        updateUIState();
        focusScanInput();
    }

    function focusScanInput() {
        const input = document.getElementById('main-scanner-input');
        if (input) {
            input.value = '';
            input.focus();
        }
    }

    function updateUIState() {
        document.querySelectorAll('.scan-step').forEach(step => {
            if (step.id === `step-${currentStep}`) {
                step.classList.remove('hidden');
            } else {
                step.classList.add('hidden');
            }
        });
    }

    // Handler für gescannte Barcodes
    async function handleBarcodeScan(barcode) {
        console.log(`Barcode gescannt: ${barcode}`);
        
        try {
            if (currentStep === 'tool') {
                console.log('Verarbeite Tool-Scan...');
                const response = await fetch(`/api/tools/${barcode}`);
                
                // Debug-Ausgabe der Response
                console.log('API Response Status:', response.status);
                const responseText = await response.text();
                console.log('API Response Text:', responseText);
                
                let responseData;
                try {
                    responseData = JSON.parse(responseText);
                    console.log('API Response Data (parsed):', responseData);
                } catch (parseError) {
                    console.error('JSON Parse Error:', parseError);
                    throw new Error('Ungültige Serverantwort');
                }
                
                if (!response.ok) {
                    throw new Error(responseData.error || 'Tool nicht gefunden');
                }
                
                scannedTool = responseData;
                currentStep = 'worker';
                updateToolPreview(responseData);
                updateUIState();
                
            } else if (currentStep === 'worker') {
                console.log('Verarbeite Worker-Scan...');
                const response = await fetch(`/api/workers/${barcode}`);
                if (!response.ok) throw new Error('Mitarbeiter nicht gefunden');
                
                const workerData = await response.json();
                console.log('Mitarbeiter-Daten empfangen:', workerData);
                
                scannedWorker = workerData;
                currentStep = 'confirm';
                updateWorkerPreview(workerData);
                showConfirmation();
            }
        } catch (error) {
            console.error('Scan-Fehler:', error);
            showError(`Scan-Fehler: ${error.message}`);
            resetScanState();
        }
    }

    function updateToolPreview(toolData) {
        console.log('Aktualisiere Tool-Vorschau:', toolData);
        const preview = document.getElementById('tool-preview');
        if (preview) {
            preview.innerHTML = `
                <div class="bg-base-200 rounded-xl p-6">
                    <h3 class="font-bold text-xl mb-2">${toolData.name}</h3>
                    <p class="text-sm opacity-70">${toolData.description || ''}</p>
                    <div class="mt-2">
                        <span class="badge badge-primary">${toolData.type || ''}</span>
                        <span class="badge">${toolData.location || ''}</span>
                    </div>
                </div>
            `;
        }
    }

    function updateWorkerPreview(worker) {
        console.log('Aktualisiere Worker-Vorschau');
        const preview = document.getElementById('worker-preview');
        if (preview) {
            preview.innerHTML = `
                <div class="text-center">
                    <p class="font-bold text-xl">${worker.firstname} ${worker.lastname}</p>
                    <p class="text-sm opacity-70">${worker.department || ''}</p>
                </div>
            `;
        }
    }

    function showConfirmation() {
        console.log('Zeige Bestätigung');
        const confirmStep = document.getElementById('step-confirm');
        if (!confirmStep) {
            console.error('Bestätigungs-Step nicht gefunden!');
            return;
        }

        confirmStep.innerHTML = `
            <div class="text-center mb-6">
                <i class="fas fa-check-circle text-5xl text-success mb-4"></i>
                <h4 class="text-xl font-bold mb-2">Bestätigung</h4>
                <p class="mb-4">
                    Werkzeug: <strong>${scannedTool.name}</strong><br>
                    Mitarbeiter: <strong>${scannedWorker.firstname} ${scannedWorker.lastname}</strong>
                </p>
                <div class="flex justify-center gap-4">
                    <button onclick="processQuickScan()" class="btn btn-success">
                        <i class="fas fa-check mr-2"></i>Bestätigen
                    </button>
                    <button onclick="resetQuickScan()" class="btn btn-ghost">
                        <i class="fas fa-times mr-2"></i>Abbrechen
                    </button>
                </div>
            </div>
        `;
        updateUIState();
    }

    async function processQuickScan() {
        try {
            const result = await LendingService.processLending(
                scannedTool, 
                scannedWorker
            );

            alert(result.message);
            if (result.success) {
                resetQuickScan();
            }
        } catch (error) {
            alert(error.message);
        }
    }

    async function returnTool(toolBarcode) {
        if (!confirm('Möchten Sie die Rückgabe wirklich durchführen?')) return;
        
        const success = await LendingService.returnItem(toolBarcode);
        if (success) {
            location.reload();
        }
    }

    // Hilfsfunktionen für Benachrichtigungen
    function showError(message) {
        console.error(message);
        alert(message);
    }

    function showSuccess(message) {
        console.log(message);
        alert(message);
    }

    // Event Listener für Barcode-Input
    document.addEventListener('DOMContentLoaded', function() {
        const scannerInput = document.getElementById('main-scanner-input');
        if (scannerInput) {
            scannerInput.addEventListener('input', function(e) {
                // Nur ausführen, wenn das QuickScan-Modal offen ist
                const quickScanModal = document.getElementById('quickScanModal');
                if (!quickScanModal || quickScanModal.style.display === 'none') return;
                
                const barcode = e.target.value.trim();
                if (barcode.length > 0) {
                    handleBarcodeScan(barcode);
                    e.target.value = '';
                }
            });
            
            // Fokus wiederherstellen, wenn er verloren geht
            scannerInput.addEventListener('blur', function() {
                // Nur ausführen, wenn das QuickScan-Modal offen ist
                const quickScanModal = document.getElementById('quickScanModal');
                if (!quickScanModal || quickScanModal.style.display === 'none') return;
                
                setTimeout(() => {
                    scannerInput.focus();
                }, 100);
            });
        }
    });

    // Theme Management
    document.addEventListener('DOMContentLoaded', function() {
        // Theme aus localStorage laden oder System-Einstellung nutzen
        const savedTheme = localStorage.getItem('theme') || 
                          (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        
        // Theme initial setzen
        document.documentElement.setAttribute('data-theme', savedTheme);
        
        // Checkbox-Status setzen
        const themeToggle = document.querySelector('.theme-controller');
        if (themeToggle) {
            themeToggle.checked = savedTheme === 'dark';
        }

        // Theme Toggle Event Listener
        document.querySelector('.theme-controller')?.addEventListener('change', function(e) {
            const newTheme = e.target.checked ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', newTheme);
            try {
                localStorage.setItem('theme', newTheme);
            } catch (e) {
                console.error('Theme konnte nicht gespeichert werden:', e);
            }
        });
    });

    document.addEventListener('DOMContentLoaded', function() {
        console.log('Checking LendingService:', window.LendingService);
    });

    document.addEventListener('DOMContentLoaded', function() {
        function updateLogoColor() {
            // Hole den aktuellen Primary-Farbwert
            const primaryHsl = getComputedStyle(document.documentElement)
                .getPropertyValue('--p')
                .trim();

            try {
                // Extrahiere den Farbton (Hue) aus dem HSL-Wert
                const hue = parseInt(primaryHsl.split(' ')[0]);
                
                // Berechne die Rotation basierend auf dem Farbton
                let hueRotation = hue;
                
                // Setze die Custom Property für den Farbton
                document.documentElement.style.setProperty('--primary-hue', `${hueRotation}deg`);
                
                console.log('Logo color updated with hue:', hueRotation);
            } catch (e) {
                console.error('Error updating logo color:', e);
            }
        }

        // Beobachte den Color Picker direkt
        const primaryColor = document.getElementById('primaryColor');
        if (primaryColor) {
            primaryColor.addEventListener('input', function() {
                // Konvertiere Hex zu HSL
                const hex = this.value;
                const rgb = hexToRGB(hex);
                const hsl = rgbToHSL(rgb.r, rgb.g, rgb.b);
                
                // Setze die Rotation direkt
                document.documentElement.style.setProperty('--primary-hue', `${hsl.h}deg`);
            });
        }

        // Hilfsfunktionen für Farbkonvertierung
        function hexToRGB(hex) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return { r, g, b };
        }

        function rgbToHSL(r, g, b) {
            r /= 255;
            g /= 255;
            b /= 255;

            const max = Math.max(r, g, b);
            const min = Math.min(r, g, b);
            let h, s, l = (max + min) / 2;

            if (max === min) {
                h = s = 0;
            } else {
                const d = max - min;
                s = l > 0.5 ? d / (2 - max - min) : d / (max + min);

                switch (max) {
                    case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                    case g: h = (b - r) / d + 2; break;
                    case b: h = (r - g) / d + 4; break;
                }

                h = Math.round(h * 60);
            }

            return { h, s: s * 100, l: l * 100 };
        }

        // Initial ausführen
        updateLogoColor();
    });

    // Fügen Sie einen Event-Listener für Klicks außerhalb des Modals hinzu
    document.getElementById('quickScanModal')?.addEventListener('click', (e) => {
        if (e.target.id === 'quickScanModal') {
            closeQuickScan();
        }
    });

    let scanner = null;
    
    async function switchScanMode(mode) {
        const barcodeBtn = document.getElementById('barcodeModeBtn');
        const cameraBtn = document.getElementById('cameraModeBtn');
        const cameraPreview = document.getElementById('cameraPreview');
        
        // UI-Update
        if (mode === 'camera') {
            barcodeBtn.classList.remove('btn-primary');
            cameraBtn.classList.add('btn-primary');
            cameraPreview.classList.remove('hidden');
            
            try {
                // Kamera initialisieren
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "environment" } 
                });
                const video = document.getElementById('video');
                video.srcObject = stream;
                video.play();
                
                // QR-Scanner initialisieren
                if (!scanner) {
                    scanner = new Html5QrcodeScanner("cameraPreview", { 
                        fps: 10,
                        qrbox: 250
                    });
                    scanner.render((text) => {
                        handleBarcodeScan(text);
                        // Optional: Scanner nach erfolgreicher Erkennung stoppen
                        scanner.clear();
                    });
                }
            } catch (err) {
                console.error('Fehler beim Zugriff auf die Kamera:', err);
                alert('Kamera konnte nicht aktiviert werden. Bitte Berechtigungen prüfen.');
            }
        } else {
            barcodeBtn.classList.add('btn-primary');
            cameraBtn.classList.remove('btn-primary');
            cameraPreview.classList.add('hidden');
            
            // Kamera-Stream beenden
            if (scanner) {
                scanner.clear();
                scanner = null;
            }
            const video = document.getElementById('video');
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
            }
        }
    }

    // Beim Öffnen des Modals
    function showQuickScan() {
        document.getElementById('quickScanModal').showModal();
        // Standardmäßig Barcode-Modus aktivieren
        switchScanMode('barcode');
    }

    // Beim Schließen des Modals
    function closeQuickScan() {
        // Kamera-Stream beenden
        if (scanner) {
            scanner.clear();
            scanner = null;
        }
        const video = document.getElementById('video');
        if (video.srcObject) {
            video.srcObject.getTracks().forEach(track => track.stop());
        }
        document.getElementById('quickScanModal').close();
    }
    </script>

    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>

    <!-- HTML5-QR-Code-Scanner -->
    <script src="https://unpkg.com/html5-qrcode"></script>

    <!-- QuickScan Assets -->
    <script src="{{ url_for('static', filename='js/quickscan.js') }}"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/quickscan.css') }}">

    <!-- Toast -->
    <script src="{{ url_for('static', filename='js/toast.js') }}"></script>
    <script src="{{ url_for('static', filename='js/quickscan.js') }}"></script>

    <!-- Styles für die Scanner-Animation -->
    <style>
        @keyframes scanner {
            0% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(56px);
            }
            100% {
                transform: translateY(0);
            }
        }
        .animate-scanner {
            animation: scanner 2s linear infinite;
        }
    </style>
</body>
</html>